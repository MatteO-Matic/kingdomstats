var armorcolumns = [ { 
    "ClothMinusBluntParam": 0.079999998211861,
    "ItemName": "Iron-Inlaid Coif",
    "MetalDefenseValue": 16,
    "ItemDescription": "Helmet",
    "Metal": 1,
    "bIsUseOnHorse": 1,
    "Cloth": "nil",
    "WeaponWeight": 4.8000001907349,
    "VelocityExtraValue": 0,
    "ClothMinusStabParam": 0,
    "Level": 3,
    "MetalFailPro": 45,
    "IconTexture": "nil",
    "ClothDefenseValue": 16,
    "MetalMinusCutParam": 0,
    "LeatherFailPro": 45,
    "fDefenseRemoteAtk": 1,
    "Id": 17000002,
    "HealthExtraValue": 0,
    "LeatherMinusBluntParam": 0.079999998211861,
    "MetalMinusBluntParam": 0.079999998211861,
    "Leather": "nil",
    "LeatherMinusStabParam": 0,
    "SkeletalMesh": "PC_M_Wei_004.Mesh.PC_M_Wei_03helmet_004_A",
    "MetalMinusStabParam": 0,
    "LeatherMinusCutParam": 0,
    "ClothMinusCutParam": 0,
    "ClothFailPro": 40,
    "LeatherDefenseValue": 16
}];

var meleecolumns = [  {
    "ItemName": "Bronze Hilt Sword",
    "ItemDescription": "1-handed Sword",
    "DoHurtAnimTime": 0.24600000679493,
    "MetalBluntCamailValue": 71,
    "SprintAttackTime": 1.5,
    "WeaponFetchingTime": 0.2419999986887,
    "FailFireTime": 0.90799999237061,
    "bIsBeginCharge": 0,
    "ClothCutCamailValue": 46,
    "FiringTime": 0.60600000619888,
    "BackWeaponPartName": "handle",
    "Persist2DamageFactor": 1.0499999523163,
    "PersistFetching2Time": 0.34000000357628,
    "MetalCutCamailValue": 21,
    "bIsUseOnHorse": 1,
    "Persist2WeaponRange": 15,
    "LeatherStabCamailValue": 41,
    "costfield": 1,
    "IconTexture": "",
    "DamageShieldFactor": 0.30000001192093,
    "ReleasePercent": 12,
    "FrontWeaponPartName": "sword",
    "MetalStabCamailValue": 66,
    "Persist2WeaponWeightLevel": 1,
    "BeginDefendTime": 0.0010000000474975,
    "ClothStabCamailValue": 91,
    "AssaultDamageType": 2,
    "nUpDefendType": 1,
    "ScabbardMesh": "OneHsowd_LV05_85cm_01.Mesh.OneHsowd_LV05_85cm_01S",
    "nLeftAttackType": 3333,
    "WeaponCachedMaxRange": 0.81999999284744,
    "Durableness": 200,
    "fFrontWeaponPart": 80,
    "nLeftDefendType": 1,
    "nDownAttackType": 2222,
    "fWeaponLength": 90,
    "CutDamageFactor": 0.40099999308586,
    "LeatherBluntCamailValue": 46,
    "nDownDefendType": 1,
    "fPveDamageFactor": 1,
    "ReleaseParam": 0.94999998807907,
    "nRightDefendType": 1,
    "Persist1WeaponWeightLevel": 0,
    "WeaponWeightLevel": 1,
    "nRightAttackType": 3333,
    "PunctureDamageFactor": 0.4839999973774,
    "ForbidBreakTime": 0.2419999986887,
    "DoubleHitEndTime": 0.49200001358986,
    "Level": 5,
    "ItemId": 18011004,
    "nDifficuty": 3,
    "nIsPveWeapon": 1,
    "Persist1DamageFactor": 1,
    "ClothBluntCamailValue": 21,
    "DoubleHitTime": 1.2999999523163,
    "LeatherCutCamailValue": 71,
    "CannotAttackRange": 0.30000001192093,
    "fBackWeaponPartDamage": 95,
    "WeaponWeight": 3.2799999713898,
    "SkeletalMesh": "OneHsowd_LV05_85cm_01.Mesh.OneHsowd_LV05_85cm_01",
    "SucDefendTime": 0.11800000071526,
    "nUpAttackType": 3333,
    "AssaultDamageFactor": 0.30000001192093,
    "Persist1WeaponRange": 0,
    "PersistFetching1Time": 0.0099999997764826,
    "Attackspeed": 0.84800000488758,
    "DpsCut": 47.28773476115968,
    "DpsPuncture": 57.07547105988098
  }];

  var rangedcolumns = [{
    "ItemName": "Javelin",
    "vecHitOffsetY": 12,
    "ItemDescription": "物品说明-英文",
    "LongRangeDamage": 1,
    "DoHurtAnimTime": 0.60000002384186,
    "WeaponCachedMaxRange": 80,
    "HighLowDamage": 2,
    "AmmoID": 18420999,
    "LoadAmmoCount": 1,
    "fPresistHoldingToSpreadTime": 2.635999917984,
    "LongRange": 41,
    "DamageDownLv7": 0.80800002813339,
    "iFirstMinRadius": 9,
    "kind": 2,
    "nMaxFireRange": 18,
    "fHoldLvPerscent": 0.40000000596046,
    "costfield": 1,
    "DamageDownLv6": 0.80800002813339,
    "Persist1WeaponWeightLevel": 0,
    "DamageDownLv2": 0.89300000667572,
    "LoadAmmoTime": 0,
    "ShootDamageFactor": 0.61799997091293,
    "WeaponWeightLevel": 2,
    "nSwitchWeapon": 0,
    "bIsUseOnHorse": 1,
    "ShortRangeDamage": 1.1000000238419,
    "WeaponWeight": 1,
    "ShortRange": 8,
    "DamageDownLv5": 0.8299999833107,
    "Level": 4,
    "DamageDownLv8": 0.78600001335144,
    "IconTexture": "",
    "DamageDownLv9": 0.78600001335144,
    "DamageShieldFactor": 0.69999998807907,
    "HoldingTime": 2,
    "ItemId": 18160003,
    "DamageDownLv3": 0.85199999809265,
    "vecHitOffsetX": -12,
    "fOriginalSpeed": 63,
    "Persist2WeaponWeightLevel": 2,
    "ShootDamageDown": 0.032600000500679,
    "nDifficuty": 8,
    "SkeletalMesh": "throwjavelin_lv04_100cm_01.Mesh.throwjavelin_lv04_120cm_01",
    "FetchingTime": 0.28000000119209,
    "CannotAttackRange": 3,
    "DamageDownLv4": 0.8299999833107,
    "DamageDownLv1": 0.97200000286102,
    "iSecondMinRadius": 4
  }];

var defaultchecked = [];
var stringConstructor = "test".constructor;
var arrayConstructor = [].constructor;
var objectConstructor = {}.constructor;
var column_level_index = 0;


//I think this function is heavier for the browser then it's needed, todo fix. (unnecessary calls)
  $.fn.dataTable.ext.search.push(
    function( settings, data, dataIndex ) {
        var min = parseInt( $('#min').val(), 10 );
        var max = parseInt( $('#max').val(), 10 );
        var lvl = parseFloat( data[column_level_index] ) || 0; // use data for the lvl column
 
        if ( ( isNaN( min ) && isNaN( max ) ) ||
             ( isNaN( min ) && lvl <= max ) ||
             ( min <= lvl   && isNaN( max ) ) ||
             ( min <= lvl   && lvl <= max ) )
        {
            return true;
        }
        return false;
    }
);

function populatetableranged() {
    tablecolumns = rangedcolumns;
    ajaxdata = "./data/0072/rangedweapon.json";
    column_level_index = 29;

    /* Table default checked */
    defaultchecked = [
    "checkbox_ItemName",
    "checkbox_FetchingTime",
    "checkbox_Level",
    "checkbox_LongRangeDamage",
    "checkbox_LoadAmmoTime",
    "checkbox_ShootDamageFactor"];
}

function populatetablemelee(){
    tablecolumns = meleecolumns;
    ajaxdata = "./data/0072/meleeweapon.json";
    column_level_index = 48;

    /* Table default checked */
    defaultchecked = [
        "checkbox_ItemName",
        "checkbox_WeaponFetchingTime",
        "checkbox_Level",
        "checkbox_Attackspeed",
        "checkbox_DpsCut",
        "checkbox_DpsPuncture"];
}

function populatetablearmor(){
    tablecolumns = armorcolumns;
    ajaxdata = "./data/0072/armor.json";
    column_level_index = 19;
    /* Table default checked */
    defaultchecked = [
        "checkbox_ItemName",
        "checkbox_MetalDefenseValue",
        "checkbox_Level",
        "checkbox_MetalFailPro"];
}

function urlObject(options) {
    "use strict";
    /*global window, document*/

    var url_search_arr,
        option_key,
        i,
        urlObj,
        get_param,
        key,
        val,
        url_query,
        url_get_params = {},
        a = document.createElement('a'),
        default_options = {
            'url': window.location.href,
            'unescape': true,
            'convert_num': true
        };

    if (typeof options !== "object") {
        options = default_options;
    } else {
        for (option_key in default_options) {
            if (default_options.hasOwnProperty(option_key)) {
                if (options[option_key] === undefined) {
                    options[option_key] = default_options[option_key];
                }
            }
        }
    }

    a.href = options.url;
    url_query = a.search.substring(1);
    url_search_arr = url_query.split('&');

    if (url_search_arr[0].length > 1) {
        for (i = 0; i < url_search_arr.length; i += 1) {
            get_param = url_search_arr[i].split("=");

            if (options.unescape) {
                key = decodeURI(get_param[0]);
                val = decodeURI(get_param[1]);
            } else {
                key = get_param[0];
                val = get_param[1];
            }

            if (options.convert_num) {
                if (val.match(/^\d+$/)) {
                    val = parseInt(val, 10);
                } else if (val.match(/^\d+\.\d+$/)) {
                    val = parseFloat(val);
                }
            }

            if (url_get_params[key] === undefined) {
                url_get_params[key] = val;
            } else if (typeof url_get_params[key] === "string") {
                url_get_params[key] = [url_get_params[key], val];
            } else {
                url_get_params[key].push(val);
            }

            get_param = [];
        }
    }

    urlObj = {
        protocol: a.protocol,
        hostname: a.hostname,
        host: a.host,
        port: a.port,
        hash: a.hash.substr(1),
        pathname: a.pathname,
        search: a.search,
        parameters: url_get_params
    };

    return urlObj;
}

function getDataTableUrl(){
    //var table = document.getElementById("hellotable");

    //oTable.fnSettings().aoColumn[ i ].bVisible)
    //console.debug(table.settings);
    var table = $('#hellotable').DataTable();

    var rstr = window.location.origin + window.location.pathname +"?";

    table.columns().every( function () {
        if (this.visible())
        {
            rstr += "cf="+ $(this.header()).text()+"&";
        }
    } );
    
    return rstr;
}

$(document).ready(function() {

    var url = window.location.href;

    var url_params = urlObject(url).parameters;
    
    var cols = [];
    
    var exampleRecord = tablecolumns[0];
    var keys = Object.keys(exampleRecord);

    
    //for each key, add a column definition
    keys.forEach(function(k) {
        cols.push({
        title: k,
        data: k
        });
    });

    var table = $('#hellotable').DataTable({
        "columns": cols,
        "paging": true,
        "iDisplayLength": 50,
        "ajax": ajaxdata,
        "columnDefs": [
            // {
            //     "targets": [ 0 ,1 ],
            //     "visible": true,
            //     "searchable": true
            // },
            {
                "targets": ["_all"],
                "visible": false,
            }
        ]
    });
    

    table.rows.add(tablecolumns).draw();

    $('#hellotable').delegate('tbody > tr', 'click', function ()
    {
        var data = table.row( this ).data();
        window.open("/item/"+data.ItemId);
    });

    // $('#hellotable tbody').on('click', 'tr', function () {
    //     var data = table.row( this ).data();
        
    //     alert( 'You clicked on '+data.ItemId+'\'s row' );
    // } );

    if (url_params.cf != null)
    {
        if(url_params.cf.constructor == stringConstructor)
        {
            togglecheckbox("checkbox_" + url_params.cf);
        }
        else if(url_params.cf.constructor == arrayConstructor)
        {
            for (i = 0; i < url_params.cf.length; i++){
                togglecheckbox("checkbox_" + url_params.cf[i]);
            } 
        }
        else
        {
            console.debug("Unknown filter constructor");
        }      
    }
    else
    {
    //check defaults
        for (i = 0; i < defaultchecked.length; i++){
            togglecheckbox( defaultchecked[i] );
        }  
    }  

    $('input.toggle-vis').on( 'change', function (e) {
        e.preventDefault();
        // Get the column API object
        var column = table.column( $(this).attr('data-column') );

        // Toggle the visibility
        column.visible(this.checked);
    } );


	// Event listener to the two range filtering inputs to redraw on input
    $('#min, #max').keyup( function() {
        table.draw();
    } );


    function togglecheckbox(itemID){
        element = document.getElementById(itemID);
        element.checked = !element.checked;
        
        var column = table.column( $(element).attr('data-column') );
        column.visible(element.checked);
    }
} );